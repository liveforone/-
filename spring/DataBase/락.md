## 락
* 해당 문서에서는 jpa에서 락에 대해 설명한다.

## 낙관적 락 매커니즘
* jpa에서 엔티티 필드에 @Version 어노테이션을 붙인 버전 필드를 관리한다.
* 따라서 업데이트 쿼리가 나가면 자동으로 version 필드를 + 1한다.
* 그러나 벌크연산에서는 jpa를 무시하므로, 임의로 version의 값을 +1 해주어야한다.
* 쿼리 dsl에서는 .setLockMode(LockModeType.OPTIMISTIC)로 락을 건다.
* 트랜잭션을 커밋하기 전까지는 트랜잭션의 충돌을 알 수 없다.
* 실패시 발생하는 예외는 다음과 같다. 예외 : OptimisticLockingFailureException

## 낙관적 락 주의점
* @Lock 어노테이션을 붙여서 쿼리를 직접날릴때에는 select 쿼리에서만 가능하다.
* 기본적으로 @Version 어노테이션을 필드에 붙이면 자동으로 낙관적락을 수행한다.
* 문제는 update에 낙관적 락을 걸 수 없으므로 오로지 더티체킹으로만 변경할때 낙관적락이 유용한데, 
* 업데이트시 조건을 넣는등 임의의 코드를 날릴때에는 사용이 불가능하다.

## 비관적 락
* 비관적 락은 DB의 락과 동일하다.
* DB단에서 처리한다.
* 일반적으로 PESSIMISTIC_WRITE, 즉 쓰기 잠금을 많이 사용한다.
* PessimisticLockingFailureException 예외가 발생한다.

## 언제 사용할까?
* 읽기가 많이 사용되는 경우에는 비관적 락보단 낙관적 락을 사용하는 것이 좋다.
* 비관적 락은 데이터의 무결성이 정말 중요하고, 충돌이 많이 발생하여 잦은 롤백이 있는 프로젝트에 사용하는 것이 좋다.
* 이와 반대로 낙관적 락은 충돌이 많이 발생하지 않는 상황에서 사용하면 좋다.
* 재고의 경우에 그렇게 많은 충돌이 발생할것 같진 않다. 그렇다면 낙관적 락을 쓰면된다.
